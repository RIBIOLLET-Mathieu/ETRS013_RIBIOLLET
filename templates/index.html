<!DOCTYPE html>
<html lang="fr">
   <head>
      <meta charset="UTF-8" />
      <title>Calcul du temps de trajet</title>

      <link
         href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
         rel="stylesheet"
      />
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

      <style>
         body {
            margin: 0;
            padding: 0;
         }
         #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
         }
         #bottom-panels {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 20;
            display: flex;
            gap: 20px;
         }
         .custom-card {
            width: 330px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            overflow: hidden;
         }
         .vehicle-img {
            width: 120px;
            height: 70px;
            object-fit: contain;
            margin-bottom: 10px;
         }
         .arrow-btn {
            font-size: 26px;
            padding: 0 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #0d6efd;
         }
      </style>
   </head>
   <body>
      <div id="map"></div>

      <!-- FORMULAIRE TRAJET -->
      <div
         id="route-panel"
         class="card shadow p-3"
         style="
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
         "
      >
         <form id="form-route" class="d-flex gap-2">
            <input
               class="form-control"
               type="text"
               id="start"
               placeholder="Ville de départ"
               required
            />
            <input
               class="form-control"
               type="text"
               id="end"
               placeholder="Ville d'arrivée"
               required
            />
            <button class="btn btn-primary" type="submit">Afficher</button>
         </form>
      </div>

      <!-- PANNEAU SOAP -->
      <div id="bottom-panels">
         <div class="custom-card p-3">
            <h4 class="mb-3 text-primary">Calcul trajet</h4>

            <!-- CARROUSEL VEHICULE -->
            <div class="mb-3">
               <h6 class="text-secondary">Véhicule</h6>

               <div class="d-flex align-items-center justify-content-between">
                  <button id="prev-vehicle" class="arrow-btn">◀</button>
                  <div id="vehicle-display" class="flex-fill text-center"></div>
                  <button id="next-vehicle" class="arrow-btn">▶</button>
               </div>
            </div>

            <!-- FORMULAIRE -->
            <div class="d-grid gap-3">
               <div>
                  <label class="form-label">Distance (km) :</label>
                  <input class="form-control" type="number" name="distance" readonly />
               </div>

               <div>
                  <label class="form-label">Autonomie (km) :</label>
                  <input class="form-control" type="number" name="autonomie" readonly />
               </div>

               <div>
                  <label class="form-label">Recharge (min) :</label>
                  <input class="form-control" type="number" name="recharge" readonly />
               </div>
            </div>

            <!-- RESULTAT -->
            <div id="resultat-zone" class="alert alert-info mt-3 d-none">
               <div>Temps total : <b id="resultat-value"></b></div>
               <div class="text-muted mt-1" id="resultat-recharges"></div>
            </div>
         </div>
      </div>

      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

      <script>
         /* ----------------- CARTE ------------------ */

         let stationsLayer = null;
         let routeLayer = null;

         var map = L.map('map').setView([46.5, 2.5], 6);
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
         }).addTo(map);

         stationsLayer = L.layerGroup().addTo(map);

         /* ----------------- VEHICULES ------------------ */

         let vehicules = [];
         let vehiculeDetailsCache = {};
         let currentIndex = 0;

         window.addEventListener('load', () => {
            chargerVehicules();
         });

         function chargerVehicules() {
            fetch('/vehicules')
               .then((res) => res.json())
               .then((data) => {
                  vehicules = data.vehicules || [];
                  currentIndex = 0;
                  afficherVehicule();
               });
         }

         function chargerDetailsVehicule(id) {
            if (vehiculeDetailsCache[id]) {
               return Promise.resolve(vehiculeDetailsCache[id]);
            }

            return fetch(`/vehicule/${id}`)
               .then((res) => res.json())
               .then((data) => {
                  vehiculeDetailsCache[id] = data.vehicule;
                  return data.vehicule;
               });
         }

         function afficherVehicule() {
            if (!vehicules.length) return;

            const v = vehicules[currentIndex];
            const name = `${v.naming.make} ${v.naming.model} ${v.naming.version ?? ''}`;
            const img = v.media?.image?.thumbnail_url ?? '';
            const autonomyList =
               v.range?.chargetrip_range?.best ?? v.range?.chargetrip_range?.worst ?? 0;

            document.getElementById('vehicle-display').innerHTML = `
      <img src="${img}" class="vehicle-img">
      <div><strong>${name}</strong></div>
      <div class="text-muted">Autonomie : ${autonomyList} km</div>
      <div class="text-muted" id="recharge-info">Recharge : ...</div>
   `;

            chargerDetailsVehicule(v.id).then((full) => {
               const recharge = full?.recharge_estimee ?? 30;
               const autonomy =
                  full?.range?.chargetrip_range?.best ??
                  full?.range?.chargetrip_range?.worst ??
                  autonomyList;

               document.getElementById(
                  'recharge-info',
               ).innerText = `Recharge : ${recharge} min`;

               document.querySelector("input[name='autonomie']").value = autonomy;
               document.querySelector("input[name='recharge']").value = recharge;

               // ⛔ Aucun calcul ici (logique respectée)
            });
         }

         document.getElementById('prev-vehicle').onclick = () => {
            currentIndex = (currentIndex - 1 + vehicules.length) % vehicules.length;
            afficherVehicule();
         };

         document.getElementById('next-vehicle').onclick = () => {
            currentIndex = (currentIndex + 1) % vehicules.length;
            afficherVehicule();
         };

         /* ----------------- UTILITAIRES BORNES ------------------ */

         function borneLaPlusProche(point, stations) {
            let min = Infinity;
            let best = null;

            stations.forEach((s) => {
               const d = map.distance(point, [s.latitude, s.longitude]);
               if (d < min) {
                  min = d;
                  best = s;
               }
            });

            return best;
         }

         function afficherStations(stations) {
            stationsLayer.clearLayers();

            const svgIcon = `
      <svg width="30" height="30" viewBox="0 0 24 24">
         <circle cx="12" cy="12" r="11" fill="#27ae60"/>
         <path d="M13 2L6 14h5l-1 8 7-12h-5l1-8z" fill="white"/>
      </svg>
   `;

            stations.forEach((s) => {
               const icon = L.divIcon({
                  html: svgIcon,
                  iconSize: [30, 30],
                  iconAnchor: [15, 15],
                  className: '',
               });

               L.marker([s.latitude, s.longitude], { icon })
                  .bindPopup(
                     `<b>${s.station}</b><br>
             Recharge VE<br>
             ${Math.round(s.distance_m)} m`,
                  )
                  .addTo(stationsLayer);
            });
         }

         /* ----------------- CALCUL TEMPS FINAL ------------------ */

         async function recalculerTrajet() {
            const d = parseFloat(document.querySelector("input[name='distance']").value);
            const a = parseFloat(document.querySelector("input[name='autonomie']").value);
            const r = parseFloat(document.querySelector("input[name='recharge']").value);

            if (isNaN(d) || isNaN(a) || isNaN(r)) return;

            const response = await fetch('/api/calcul_trajet', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({ distance: d, autonomie: a, recharge: r }),
            });

            const data = await response.json();
            if (data.error) return;

            const totalMin = Math.round(data.total_h * 60);
            const h = Math.floor(totalMin / 60);
            const m = totalMin % 60;

            document.getElementById('resultat-value').innerText =
               m === 0 ? `${h} h` : `${h} h ${m} min`;

            document.getElementById('resultat-recharges').innerText =
               data.nb_recharges > 0
                  ? `${data.nb_recharges} recharge(s) • ${data.recharge_min_total} min`
                  : 'Aucune recharge nécessaire';

            document.getElementById('resultat-zone').classList.remove('d-none');
         }
      </script>

      <script>
         document
            .getElementById('form-route')
            .addEventListener('submit', async function (e) {
               e.preventDefault();

               const start = document.getElementById('start').value;
               const end = document.getElementById('end').value;

               const autonomie = parseFloat(
                  document.querySelector("input[name='autonomie']").value,
               );

               /* 1️⃣ Géométrie brute (sans affichage) */
               const res = await fetch(`/route?start=${start}&end=${end}`);
               const data = await res.json();
               if (data.error) {
                  alert(data.message);
                  return;
               }

               const latlngs = data.geometry.coordinates.map((c) => [c[1], c[0]]);

               /* 2️⃣ Sélection INTELLIGENTE des bornes */
               const seuil = autonomie * 0.2;
               let autonomieRestante = autonomie;
               let dernierPoint = latlngs[0];
               let bornesChoisies = [];

               for (let i = 1; i < latlngs.length; i++) {
                  const d = map.distance(dernierPoint, latlngs[i]) / 1000;
                  autonomieRestante -= d;

                  if (autonomieRestante <= seuil) {
                     const [lat, lon] = latlngs[i];
                     const r = await fetch(`/station?lat=${lat}&lon=${lon}&rayon=2000`);
                     const sdata = await r.json();

                     if (!sdata.error && sdata.stations.length) {
                        const borne = borneLaPlusProche(latlngs[i], sdata.stations);
                        bornesChoisies.push(borne);
                        autonomieRestante = autonomie;
                        dernierPoint = [borne.latitude, borne.longitude];
                     }
                  } else {
                     dernierPoint = latlngs[i];
                  }
               }

               /* 3️⃣ Trajet FINAL */
               const coordsFinales = [
                  latlngs[0],
                  ...bornesChoisies.map((b) => [b.latitude, b.longitude]),
                  latlngs[latlngs.length - 1],
               ];

               const r2 = await fetch('/route_multi', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ coords: coordsFinales }),
               });

               const d2 = await r2.json();
               const finalLatLngs = d2.geometry.coordinates.map((c) => [c[1], c[0]]);

               /* 4️⃣ Affichage UNIQUE */
               if (routeLayer) map.removeLayer(routeLayer);
               routeLayer = L.polyline(finalLatLngs, {
                  color: 'blue',
                  weight: 5,
               }).addTo(map);

               map.fitBounds(routeLayer.getBounds());

               /* 5️⃣ Bornes utiles uniquement */
               afficherStations(bornesChoisies);

               /* 6️⃣ Distance + temps FINAL */
               const km = (d2.distance_m / 1000).toFixed(1);
               document.querySelector("input[name='distance']").value = km;

               await recalculerTrajet();
            });
      </script>
   </body>
</html>
