<!DOCTYPE html>
<html lang="fr">
   <head>
      <meta charset="UTF-8" />
      <title>Calcul du temps de trajet</title>

      <link
         href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
         rel="stylesheet"
      />
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

      <style>
         body {
            margin: 0;
            padding: 0;
         }
         #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
         }
         #bottom-panels {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 20;
            display: flex;
            gap: 20px;
         }
         .custom-card {
            width: 330px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            overflow: hidden;
         }
         .vehicle-img {
            width: 120px;
            height: 70px;
            object-fit: contain;
            margin-bottom: 10px;
         }
         .arrow-btn {
            font-size: 26px;
            padding: 0 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #0d6efd;
         }
      </style>
   </head>
   <body>
      <div id="map"></div>

      <!-- FORMULAIRE TRAJET -->
      <div
         id="route-panel"
         class="card shadow p-3"
         style="
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
         "
      >
         <form id="form-route" class="d-flex gap-2">
            <input
               class="form-control"
               type="text"
               id="start"
               placeholder="Ville de départ"
               required
            />
            <input
               class="form-control"
               type="text"
               id="end"
               placeholder="Ville d'arrivée"
               required
            />
            <button class="btn btn-primary" type="submit">Afficher</button>
         </form>
      </div>

      <!-- PANNEAU SOAP -->
      <div id="bottom-panels">
         <div class="custom-card p-3">
            <h4 class="mb-3 text-primary">Calcul trajet</h4>

            <!-- CARROUSEL VEHICULE -->
            <div class="mb-3">
               <h6 class="text-secondary">Véhicule</h6>

               <div class="d-flex align-items-center justify-content-between">
                  <button id="prev-vehicle" class="arrow-btn">◀</button>
                  <div id="vehicle-display" class="flex-fill text-center"></div>
                  <button id="next-vehicle" class="arrow-btn">▶</button>
               </div>
            </div>

            <!-- FORMULAIRE -->
            <div class="d-grid gap-3">
               <div>
                  <label class="form-label">Distance (km) :</label>
                  <input class="form-control" type="number" name="distance" readonly />
               </div>

               <div>
                  <label class="form-label">Autonomie (km) :</label>
                  <input class="form-control" type="number" name="autonomie" readonly />
               </div>

               <div>
                  <label class="form-label">Recharge (min) :</label>
                  <input class="form-control" type="number" name="recharge" readonly />
               </div>
            </div>

            <!-- RESULTAT -->
            <div id="resultat-zone" class="alert alert-info mt-3 d-none">
               Temps total : <b id="resultat-value"></b>
            </div>
         </div>
      </div>

      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

      <script>
         /* ----------------- CARTE ------------------ */

         var map = L.map('map').setView([46.5, 2.5], 6);
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
         }).addTo(map);
         let routeLayer = null;

         /* ----------------- VEHICULES ------------------ */

         let vehicules = [];
         let vehiculeDetailsCache = {};
         let currentIndex = 0;

         window.addEventListener('load', () => {
            chargerVehicules();
         });

         function chargerVehicules() {
            fetch('/vehicules')
               .then((res) => res.json())
               .then((data) => {
                  vehicules = data.vehicules || [];
                  currentIndex = 0;
                  afficherVehicule();
               });
         }

         function chargerDetailsVehicule(id) {
            if (vehiculeDetailsCache[id])
               return Promise.resolve(vehiculeDetailsCache[id]);

            return fetch(`/vehicule/${id}`)
               .then((res) => res.json())
               .then((data) => {
                  vehiculeDetailsCache[id] = data.vehicule;
                  return data.vehicule;
               });
         }

         function afficherVehicule() {
            if (!vehicules.length) return;

            const v = vehicules[currentIndex];
            const name = `${v.naming.make} ${v.naming.model} ${v.naming.version ?? ''}`;
            const img = v.media?.image?.thumbnail_url ?? '';
            const autonomyList =
               v.range?.chargetrip_range?.best ?? v.range?.chargetrip_range?.worst ?? 0;

            document.getElementById('vehicle-display').innerHTML = `
                        <img src="${img}" class="vehicle-img">
                        <div><strong>${name}</strong></div>
                        <div class="text-muted">Autonomie : ${autonomyList} km</div>
                        <div class="text-muted" id="recharge-info">Recharge : ...</div>
                     `;

            chargerDetailsVehicule(v.id).then((full) => {
               const recharge = full?.recharge_estimee ?? 30;
               const autonomy =
                  full?.range?.chargetrip_range?.best ??
                  full?.range?.chargetrip_range?.worst ??
                  autonomyList;

               document.getElementById(
                  'recharge-info',
               ).innerText = `Recharge : ${recharge} min`;

               // Mise à jour automatique du formulaire
               document.querySelector("input[name='autonomie']").value = autonomy;
               document.querySelector("input[name='recharge']").value = recharge;

               recalculerTrajet(); // ⚡ recalcul automatique
            });
         }

         document.getElementById('prev-vehicle').onclick = () => {
            currentIndex = (currentIndex - 1 + vehicules.length) % vehicules.length;
            afficherVehicule();
         };
         document.getElementById('next-vehicle').onclick = () => {
            currentIndex = (currentIndex + 1) % vehicules.length;
            afficherVehicule();
         };

         /* ----------------- TRAJET ------------------ */

         document.getElementById('form-route').addEventListener('submit', function (e) {
            e.preventDefault();

            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;

            fetch(`/route?start=${start}&end=${end}`)
               .then((res) => res.json())
               .then((data) => {
                  if (data.error) {
                     alert(data.message);
                     return;
                  }

                  const coords = data.geometry.coordinates;
                  const latlngs = coords.map((c) => [c[1], c[0]]);

                  if (routeLayer) map.removeLayer(routeLayer);
                  routeLayer = L.polyline(latlngs, { color: 'blue', weight: 5 }).addTo(
                     map,
                  );

                  map.fitBounds(routeLayer.getBounds());

                  // Distance en km
                  const km = (data.distance_m / 1000).toFixed(1);
                  document.querySelector("input[name='distance']").value = km;

                  recalculerTrajet(); // ⚡ recalcul automatique
               });
         });

         /* helper: formatte un total en heures en "XX min" ou "H h MM min" */
         function formatHoursToHuman(total_hours) {
            const total_minutes = Math.round(total_hours * 60);
            if (total_minutes < 60) return `${total_minutes} min`;
            const h = Math.floor(total_minutes / 60);
            const m = total_minutes % 60;
            return m === 0 ? `${h} h` : `${h} h ${m} min`;
         }

         /* nouvelle version de recalculerTrajet() */
         async function recalculerTrajet() {
            const d = parseFloat(document.querySelector("input[name='distance']").value);
            const a = parseFloat(document.querySelector("input[name='autonomie']").value);
            const r = parseFloat(document.querySelector("input[name='recharge']").value);

            if (isNaN(d) || isNaN(a) || isNaN(r) || d <= 0 || a <= 0 || r <= 0) {
               document.getElementById('resultat-zone').classList.add('d-none');
               return;
            }

            // appel SOAP → retourne total_h, nb_recharges, recharge_min_total
            const soapEnvelope = `
    <soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
                      xmlns:tra="tns">
      <soapenv:Body>
        <tra:calcul_temps_trajet>
          <distance_km>${d}</distance_km>
          <autonomie_km>${a}</autonomie_km>
          <temps_recharge_min>${r}</temps_recharge_min>
        </tra:calcul_temps_trajet>
      </soapenv:Body>
    </soapenv:Envelope>
  `;

            const response = await fetch('/soap', {
               method: 'POST',
               headers: { 'Content-Type': 'text/xml' },
               body: soapEnvelope,
            });

            const txt = await response.text();

            // on parse le XML
            const parser = new DOMParser();
            const xml = parser.parseFromString(txt, 'text/xml');

            // valeurs récupérées
            const total_h = parseFloat(xml.querySelector('total_h')?.textContent || 0);
            const nb_rec = parseFloat(
               xml.querySelector('nb_recharges')?.textContent || 0,
            );
            const rec_min = parseFloat(
               xml.querySelector('recharge_min_total')?.textContent || 0,
            );

            // Formatage humain
            const human = formatHoursToHuman(total_h);

            // Affichage dans le DOM
            document.getElementById('resultat-value').innerText = human;
            document.getElementById(
               'resultat-recharges',
            ).innerText = `${nb_rec} recharge(s) • ${rec_min} min au total`;

            document.getElementById('resultat-zone').classList.remove('d-none');
         }
      </script>
   </body>
</html>
