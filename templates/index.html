<!DOCTYPE html>
<html lang="fr">
   <head>
      <meta charset="UTF-8" />
      <title>Calcul du temps de trajet</title>

      <link
         href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
         rel="stylesheet"
      />
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

      <style>
         body {
            margin: 0;
            padding: 0;
         }
         #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
         }
         #bottom-panels {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 20;
            display: flex;
            gap: 20px;
         }
         .custom-card {
            width: 330px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
            overflow: hidden;
         }
         .vehicle-img {
            width: 120px;
            height: 70px;
            object-fit: contain;
            margin-bottom: 10px;
         }
         .arrow-btn {
            font-size: 26px;
            padding: 0 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #0d6efd;
         }
         #bornes-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 450px;
            height: 100vh;
            background: #ffffff;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
            z-index: 999;
            display: flex;
         }

         #bornes-panel.closed {
            transform: translateX(414px);
         }

         #toggle-panel {
            width: 40px;
            background: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
         }

         #toggle-arrow {
            font-size: 20px;
            transition: transform 0.3s ease;
         }

         #bornes-panel.closed #toggle-arrow {
            transform: rotate(180deg);
         }

         .panel-content {
            padding: 15px;
            overflow-y: auto;
            width: 100%;
         }

         .borne-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #22c55e;
         }

         .borne-card h4 {
            margin: 0 0 5px 0;
         }

         .borne-card small {
            color: #64748b;
         }
         /* ---------- THEME MODERNE ---------- */

         :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.3);
            --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.25);
            --primary-gradient: linear-gradient(135deg, #0d6efd, #22c55e);
         }

         /* Fond carte l√©g√®rement assombri */
         .leaflet-container {
            filter: saturate(1.1) contrast(1.05);
         }

         /* ---------- PANNEAUX FLOTTANTS ---------- */

         .custom-card,
         #route-panel {
            backdrop-filter: blur(14px);
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
            animation: floatIn 0.6s ease-out;
         }

         @keyframes floatIn {
            from {
               opacity: 0;
               transform: translateY(20px) scale(0.97);
            }
            to {
               opacity: 1;
               transform: translateY(0) scale(1);
            }
         }

         /* ---------- BOUTONS ---------- */

         .btn-primary {
            background: var(--primary-gradient);
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
         }

         .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(13, 110, 253, 0.35);
         }

         /* ---------- CARROUSEL VEHICULE ---------- */

         #vehicle-display {
            transition: transform 0.3s ease, opacity 0.3s ease;
         }

         .vehicle-img {
            transition: transform 0.3s ease;
         }

         .vehicle-img:hover {
            transform: scale(1.05);
         }

         .arrow-btn {
            transition: transform 0.2s ease, color 0.2s ease;
         }

         .arrow-btn:hover {
            transform: scale(1.2);
            color: #22c55e;
         }

         /* ---------- SLIDER ---------- */

         input[type='range'] {
            accent-color: #22c55e;
         }

         /* ---------- RESULTAT ---------- */

         #resultat-zone {
            animation: slideUp 0.5s ease forwards;
         }

         @keyframes slideUp {
            from {
               opacity: 0;
               transform: translateY(10px);
            }
            to {
               opacity: 1;
               transform: translateY(0);
            }
         }

         /* ---------- PANNEAU BORNES ---------- */

         #bornes-panel {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.95);
         }

         .borne-card {
            animation: fadeInCard 0.4s ease forwards;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
         }

         .borne-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
         }

         @keyframes fadeInCard {
            from {
               opacity: 0;
               transform: translateX(10px);
            }
            to {
               opacity: 1;
               transform: translateX(0);
            }
         }

         /* ---------- MARKERS LEAFLET ---------- */

         .leaflet-marker-icon {
            animation: popMarker 0.4s ease;
         }

         @keyframes popMarker {
            from {
               transform: scale(0);
            }
            to {
               transform: scale(1);
            }
         }
      </style>
   </head>
   <body>
      <div id="map"></div>

      <!-- FORMULAIRE TRAJET -->
      <div
         id="route-panel"
         class="card shadow p-3"
         style="
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
         "
      >
         <form id="form-route" class="d-flex gap-2">
            <input
               class="form-control"
               type="text"
               id="start"
               placeholder="Ville de d√©part"
               required
            />
            <input
               class="form-control"
               type="text"
               id="end"
               placeholder="Ville d'arriv√©e"
               required
            />
            <button class="btn btn-primary" type="submit">Afficher</button>
         </form>
      </div>

      <!-- PANNEAU SOAP -->
      <div id="bottom-panels">
         <div class="custom-card p-3">
            <h4 class="mb-3 text-primary">Calcul trajet</h4>

            <!-- CARROUSEL VEHICULE -->
            <div class="mb-3">
               <h6 class="text-secondary">V√©hicule</h6>

               <div class="d-flex align-items-center justify-content-between">
                  <button id="prev-vehicle" class="arrow-btn">‚óÄ</button>
                  <div id="vehicle-display" class="flex-fill text-center"></div>
                  <button id="next-vehicle" class="arrow-btn">‚ñ∂</button>
               </div>
            </div>

            <!-- FORMULAIRE -->
            <div class="d-grid gap-3">
               <div>
                  <label class="form-label">Distance (km) :</label>
                  <input class="form-control" type="number" name="distance" readonly />
               </div>

               <div>
                  <label class="form-label">Autonomie (km) :</label>
                  <input class="form-control" type="number" name="autonomie" readonly />
               </div>

               <label>
                  Seuil de recharge :
                  <strong><span id="seuil-valeur">20</span>%</strong>
               </label>
               <input type="range" id="seuil" min="5" max="40" value="20" step="5" />
            </div>

            <!-- RESULTAT -->
            <div id="resultat-zone" class="alert alert-info mt-3 d-none">
               <div>Temps total : <b id="resultat-value"></b></div>
               <div class="text-muted mt-1" id="resultat-recharges"></div>
            </div>
         </div>
      </div>
      <div id="bornes-panel" class="closed">
         <div id="toggle-panel">
            <span id="toggle-arrow">‚óÄ</span>
         </div>

         <div class="panel-content">
            <h3>üîå Bornes utilis√©es</h3>
            <div id="liste-bornes"></div>
         </div>
      </div>

      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

      <script>
         let bornesChoisiesGlobal = [];

         /* Slider pour choix du seuil d'autonomie */
         const slider = document.getElementById('seuil');
         const affichageSeuil = document.getElementById('seuil-valeur');

         affichageSeuil.innerText = slider.value;

         slider.oninput = () => {
            affichageSeuil.innerText = slider.value;
         };

         /* ----------------- CARTE ------------------ */

         let stationsLayer = null;
         let routeLayer = null;
         let startMarker = null;
         let endMarker = null;

         var map = L.map('map').setView([46.5, 2.5], 6);
         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
         }).addTo(map);

         stationsLayer = L.layerGroup().addTo(map);

         /* ---------- ICONES DEPART / ARRIVEE ---------- */

         const startIcon = L.icon({
            iconUrl:
               'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
         });

         const endIcon = L.icon({
            iconUrl:
               'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
         });

         /* ----------------- VEHICULES ------------------ */

         let vehicules = [];
         let vehiculeDetailsCache = {};
         let currentIndex = 0;

         window.addEventListener('load', () => {
            chargerVehicules();
         });

         function chargerVehicules() {
            fetch('/vehicules')
               .then((res) => res.json())
               .then((data) => {
                  vehicules = data.vehicules || [];
                  currentIndex = 0;
                  afficherVehicule();
               });
         }

         function chargerDetailsVehicule(id) {
            if (vehiculeDetailsCache[id]) {
               return Promise.resolve(vehiculeDetailsCache[id]);
            }

            return fetch(`/vehicule/${id}`)
               .then((res) => res.json())
               .then((data) => {
                  vehiculeDetailsCache[id] = data.vehicule;
                  return data.vehicule;
               });
         }

         function afficherVehicule() {
            if (!vehicules.length) return;

            const v = vehicules[currentIndex];
            const name = `${v.naming.make} ${v.naming.model} ${v.naming.version ?? ''}`;
            const img = v.media?.image?.thumbnail_url ?? '';
            const autonomyList =
               v.range?.chargetrip_range?.best ?? v.range?.chargetrip_range?.worst ?? 0;

            const container = document.getElementById('vehicle-display');
            container.style.opacity = 0;
            container.style.transform = 'translateY(10px)';

            setTimeout(() => {
               container.innerHTML = `
      <img src="${img}" class="vehicle-img">
      <div><strong>${name}</strong></div>
      <div class="text-muted">Autonomie : ${autonomyList} km</div>
      <div class="text-muted" id="recharge-info">Recharge : ...</div>
   `;
               container.style.opacity = 1;
               container.style.transform = 'translateY(0)';
            }, 150);

            chargerDetailsVehicule(v.id).then((full) => {
               const recharge = full?.recharge_estimee ?? 30;
               const autonomy =
                  full?.range?.chargetrip_range?.best ??
                  full?.range?.chargetrip_range?.worst ??
                  autonomyList;

               document.getElementById(
                  'recharge-info',
               ).innerText = `Recharge : ${recharge} min`;

               document.querySelector("input[name='autonomie']").value = autonomy;

               // ‚õî Aucun calcul ici (logique respect√©e)
            });
         }

         document.getElementById('prev-vehicle').onclick = () => {
            currentIndex = (currentIndex - 1 + vehicules.length) % vehicules.length;
            afficherVehicule();
         };

         document.getElementById('next-vehicle').onclick = () => {
            currentIndex = (currentIndex + 1) % vehicules.length;
            afficherVehicule();
         };

         /* ----------------- UTILITAIRES BORNES ------------------ */

         function borneLaPlusProche(point, stations) {
            let min = Infinity;
            let best = null;

            stations.forEach((s) => {
               const d = map.distance(point, [s.latitude, s.longitude]);
               if (d < min) {
                  min = d;
                  best = s;
               }
            });

            return best;
         }

         function afficherStations(stations) {
            stationsLayer.clearLayers();

            const svgIcon = `
      <svg width="30" height="30" viewBox="0 0 24 24">
         <circle cx="12" cy="12" r="11" fill="#27ae60"/>
         <path d="M13 2L6 14h5l-1 8 7-12h-5l1-8z" fill="white"/>
      </svg>
   `;

            stations.forEach((s) => {
               const icon = L.divIcon({
                  html: svgIcon,
                  iconSize: [30, 30],
                  iconAnchor: [15, 15],
                  className: '',
               });

               L.marker([s.latitude, s.longitude], { icon })
                  .bindPopup(
                     `<b>${s.station}</b><br>
             Recharge VE<br>
             ${Math.round(s.distance_m)} m`,
                  )
                  .addTo(stationsLayer);
            });
         }

         /* ----------------- CALCUL TEMPS FINAL ------------------ */

         async function recalculerTrajet() {
            const d = parseFloat(document.querySelector("input[name='distance']").value);

            if (isNaN(d)) return;

            const response = await fetch('/api/calcul_trajet', {
               method: 'POST',
               headers: { 'Content-Type': 'application/json' },
               body: JSON.stringify({
                  distance: d,
                  autonomie: parseFloat(
                     document.querySelector("input[name='autonomie']").value,
                  ),
                  recharge: 0, // ‚ö†Ô∏è plus utilis√© c√¥t√© backend
                  nb_recharges: bornesChoisiesGlobal.length,
               }),
            });

            const data = await response.json();
            if (data.error) return;

            // ‚è±Ô∏è Temps conduite (API)
            const driveMin = Math.round(data.drive_h * 60);

            // üîå Temps recharge (calcul√© localement)
            const rechargeMin = window.tempsRechargeTotal ?? 0;

            // ‚è±Ô∏è Temps total FINAL
            const totalMin = driveMin + rechargeMin;

            const h = Math.floor(totalMin / 60);
            const m = totalMin % 60;

            document.getElementById('resultat-value').innerText =
               m === 0 ? `${h} h` : `${h} h ${m} min`;

            document.getElementById('resultat-recharges').innerText =
               bornesChoisiesGlobal.length > 0
                  ? `${bornesChoisiesGlobal.length} recharge(s) ‚Ä¢ ${window.tempsRechargeTotal} min`
                  : 'Aucune recharge n√©cessaire';

            document.getElementById('resultat-zone').classList.remove('d-none');
         }
      </script>

      <script>
         document
            .getElementById('form-route')
            .addEventListener('submit', async function (e) {
               e.preventDefault();

               const start = document.getElementById('start').value;
               const end = document.getElementById('end').value;

               const autonomie = parseFloat(
                  document.querySelector("input[name='autonomie']").value,
               );

               /* üîã Capacit√© batterie (kWh) depuis le v√©hicule courant */
               const vehicule = vehicules[currentIndex];
               const capaciteKwh =
                  vehiculeDetailsCache[vehicule.id]?.battery?.usable_kwh ?? 50;

               /* 1Ô∏è‚É£ G√©om√©trie brute */
               const res = await fetch(`/route?start=${start}&end=${end}`);
               const data = await res.json();
               if (data.error) {
                  alert(data.message);
                  return;
               }

               const latlngs = data.geometry.coordinates.map((c) => [c[1], c[0]]);

               /* üìç MARQUEURS DEPART / ARRIVEE */

               // Nettoyage anciens markers
               if (startMarker) map.removeLayer(startMarker);
               if (endMarker) map.removeLayer(endMarker);

               // Coordonn√©es
               const startLatLng = latlngs[0];
               const endLatLng = latlngs[latlngs.length - 1];

               // Marker d√©part (rouge)
               startMarker = L.marker(startLatLng, { icon: startIcon })
                  .bindPopup('üö© D√©part')
                  .addTo(map);

               // Marker arriv√©e (vert)
               endMarker = L.marker(endLatLng, { icon: endIcon })
                  .bindPopup('üèÅ Arriv√©e')
                  .addTo(map);

               /* 2Ô∏è‚É£ S√©lection INTELLIGENTE des bornes */
               const seuilPourcent =
                  parseFloat(document.getElementById('seuil').value) / 100;
               const seuilKm = autonomie * seuilPourcent;

               let autonomieRestante = autonomie;
               let dernierPoint = latlngs[0];
               let bornesChoisies = [];

               for (let i = 1; i < latlngs.length; i++) {
                  const d = map.distance(dernierPoint, latlngs[i]) / 1000;
                  autonomieRestante -= d;

                  if (autonomieRestante <= seuilKm) {
                     const [lat, lon] = latlngs[i];
                     const r = await fetch(`/station?lat=${lat}&lon=${lon}&rayon=2000`);
                     const sdata = await r.json();

                     if (!sdata.error && sdata.stations.length) {
                        const borne = borneLaPlusProche(latlngs[i], sdata.stations);

                        /* ‚ö° PUISSANCE BORNE */
                        let puissance = parseFloat(borne.puiss_max);
                        if (isNaN(puissance)) puissance = 22;
                        puissance = Math.min(puissance, 150);

                        /* üîã √âNERGIE √Ä RECHARGER (seuil ‚Üí 80%) */
                        console.log(capaciteKwh);
                        console.log(seuilPourcent);
                        const energieRechargeKwh = capaciteKwh * (0.8 - seuilPourcent);

                        console.log(`${energieRechargeKwh} / ${puissance} * 60`);
                        /* ‚è±Ô∏è TEMPS DE RECHARGE (minutes) */
                        const tempsRechargeMin = Math.round(
                           (energieRechargeKwh / puissance) * 60,
                        );

                        bornesChoisies.push({
                           station: borne.station ?? 'Borne inconnue',
                           acces: borne.acces_recharge ?? 'Inconnu',
                           puissance_kw: puissance,
                           temps_recharge_min: tempsRechargeMin,
                           latitude: borne.latitude,
                           longitude: borne.longitude,
                           distance_m: borne.distance_m ?? 0,
                        });

                        autonomieRestante = autonomie;
                        dernierPoint = [borne.latitude, borne.longitude];
                     }
                  } else {
                     dernierPoint = latlngs[i];
                  }
               }

               /* 3Ô∏è‚É£ Trajet FINAL */
               const coordsFinales = [
                  latlngs[0],
                  ...bornesChoisies.map((b) => [b.latitude, b.longitude]),
                  latlngs[latlngs.length - 1],
               ];

               const r2 = await fetch('/route_multi', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ coords: coordsFinales }),
               });

               const d2 = await r2.json();
               const finalLatLngs = d2.geometry.coordinates.map((c) => [c[1], c[0]]);

               /* 4Ô∏è‚É£ Affichage UNIQUE */
               if (routeLayer) map.removeLayer(routeLayer);
               routeLayer = L.polyline(finalLatLngs, {
                  color: 'blue',
                  weight: 5,
                  opacity: 0.9,
               }).addTo(map);
               routeLayer.setStyle({ dashArray: '8,12' });

               let offset = 0;
               setInterval(() => {
                  offset = (offset - 1) % 20;
                  routeLayer.setStyle({ dashOffset: offset });
               }, 60);

               map.fitBounds(routeLayer.getBounds());

               /* 5Ô∏è‚É£ Bornes utiles uniquement */
               afficherStations(bornesChoisies);
               afficherBornesDansPanneau(bornesChoisies);

               /* 6Ô∏è‚É£ Distance + temps FINAL */
               const km = (d2.distance_m / 1000).toFixed(1);
               document.querySelector("input[name='distance']").value = km;

               bornesChoisiesGlobal = bornesChoisies;
               const totalRechargeMin = bornesChoisies.reduce(
                  (sum, b) => sum + (b.temps_recharge_min ?? 0),
                  0,
               );

               window.tempsRechargeTotal = totalRechargeMin;

               await recalculerTrajet();
            });

         /* -------- PANNEAU LATERAL -------- */

         const panel = document.getElementById('bornes-panel');
         const toggle = document.getElementById('toggle-panel');

         toggle.onclick = () => {
            panel.classList.toggle('closed');
         };

         function afficherBornesDansPanneau(bornes) {
            const container = document.getElementById('liste-bornes');
            container.innerHTML = '';

            if (!bornes.length) {
               container.innerHTML = '<p>Bonne nouvelle ! Aucune recharge n√©cessaire</p>';
               return;
            }

            bornes.forEach((b, i) => {
               container.innerHTML += `
         <div class="borne-card">
            <h4>Recharge ${i + 1}</h4>
            <small>${b.station}</small><br>
            <small>Acc√®s : ${b.acces}</small><br>
            <small>Puissance : ${b.puissance_kw} kW</small><br>
            <small>Temps : ${b.temps_recharge_min} min</small>
         </div>
      `;
            });
         }
      </script>
      <!-- PANNEAU LATERAL BORNES (GLOBAL) -->
   </body>
</html>
