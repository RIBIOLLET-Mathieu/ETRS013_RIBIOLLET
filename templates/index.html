<!DOCTYPE html>
<html lang="fr">
   <head>
      <meta charset="UTF-8" />
      <title>Calcul du temps de trajet (SOAP)</title>

      <style>
         body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
         }

         /* ---- CARTE EN FOND ---- */
         #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
         }

         /* ---- STYLES PANNEAUX ---- */
         .panel-box {
            background: rgba(255, 255, 255, 0.92);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            z-index: 10;
            backdrop-filter: blur(5px);
         }

         /* ---- PANEL DU TRAJET EN HAUT ---- */
         #route-panel {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            align-items: center;
         }

         #route-panel input,
         #route-panel button {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 14px;
         }

         #route-panel button {
            background-color: #4da0ff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
         }

         #route-panel button:hover {
            background-color: #66b2ff;
         }

         /* ---- PANEL SOAP EN BAS GAUCHE ---- */
         #panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 320px;
         }

         #panel label {
            font-size: 14px;
            font-weight: bold;
         }

         .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
         }

         .input-row input {
            width: 110px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            text-align: right;
         }

         #panel button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background-color: #4da0ff;
            font-weight: bold;
            color: white;
            cursor: pointer;
            margin-top: 10px;
         }

         #panel button:hover {
            background-color: #66b2ff;
         }

         .result {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 128, 255, 0.15);
            border-radius: 8px;
            font-size: 1.1em;
         }
      </style>
   </head>
   <body>
      <!-- CARTE EN FOND -->
      <div id="map"></div>

      <!-- FORMULAIRE HAUT : TRAJET -->
      <form id="form-route">
         <div id="route-panel" class="panel-box">
            <input
               type="text"
               id="start"
               name="start"
               placeholder="Ville de départ"
               required
            />
            <input
               type="text"
               id="end"
               name="end"
               placeholder="Ville d'arrivée"
               required
            />
            <button type="submit">Afficher</button>
         </div>
      </form>

      <!-- FORMULAIRE BAS GAUCHE : SOAP -->
      <div id="panel" class="panel-box">
         <h2 style="margin-top: 0">Calcul trajet</h2>

         <form action="/calcul" method="post">
            <div class="input-row">
               <label>Distance (km):</label>
               <input type="number" name="distance" required />
            </div>

            <div class="input-row">
               <label>Autonomie (km):</label>
               <input type="number" name="autonomie" required />
            </div>

            <div class="input-row">
               <label>Recharge (min):</label>
               <input type="number" name="recharge" required />
            </div>

            <button type="submit">Calculer</button>
         </form>

         {% if resultat is not none %}
         <div class="result">Temps total : {{ resultat }} heures</div>
         {% endif %}
      </div>

      <!-- LEAFLET -->
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

      <!-- JS CARTE & TRAJET -->
      <script>
         var map = L.map('map').setView([46.5, 2.5], 6);

         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
         }).addTo(map);

         var routeLayer = null;
      </script>

      <script>
         document
            .getElementById('form-route')
            .addEventListener('submit', function (event) {
               event.preventDefault();

               const start = document.getElementById('start').value;
               const end = document.getElementById('end').value;

               fetch(`/route?start=${start}&end=${end}`)
                  .then((res) => res.json())
                  .then((data) => {
                     if (data.error) {
                        alert('Erreur : ' + data.message);
                        return;
                     }

                     const coords = data.geometry.coordinates;

                     if (routeLayer) map.removeLayer(routeLayer);

                     const latlngs = coords.map((c) => [c[1], c[0]]);

                     routeLayer = L.polyline(latlngs, { color: 'blue', weight: 5 }).addTo(
                        map,
                     );

                     map.fitBounds(routeLayer.getBounds());
                  })
                  .catch((err) => console.error(err));
            });
      </script>
   </body>
</html>
